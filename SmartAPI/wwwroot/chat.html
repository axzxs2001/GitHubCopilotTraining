<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>智能API助手</title>
    <!-- 引入 Markdown-it 和 Mermaid -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.2/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.4.0/dist/mermaid.min.js"></script>
    <style>

        /* 自定义样式：黑底白字的代码块 */
        pre {
            padding: 10px;
            background-color: #1e1e1e; /* 黑色背景 */
            color: #ffffff; /* 白色字体 */
            position: relative;
            display: inline-block;
            width: 100%
        }

            pre code {
                background-color: #1e1e1e; /* 黑色背景 */
                color: #ffffff; /* 白色字体 */
            }

        .mermaid {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .row {       
            margin-top: 15px
        }

        .copy-container {
            position: relative;
            display: inline-block;
            padding: 10px;
        }

        .copy-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            background-color: #626262;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row" >
            <div class=""></div>
            <div id="contents">
            </div>
        </div>
        <div class="row">
            <div class="col-1"></div>
            <div class="col-11 position-relative" style="padding-top: 20px;">
                <!-- 将父容器设为 position: relative -->
                <textarea class="form-control" id="question" rows="5" style="width: 100%; padding-right: 50px;"></textarea>
                <!-- 按钮绝对定位在textarea内的右下角 -->
                <button type="button" class="btn btn-success" id="send"
                        style="position: absolute; right: 14px; bottom: 2px;">
                    发送
                </button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // 初始化 Mermaid
        mermaid.initialize({ startOnLoad: false });

        // 创建自定义 Mermaid 渲染规则
        function markdownItMermaid(md) {
            const defaultFence = md.renderer.rules.fence || function (tokens, idx, options, env, self) {
                return self.renderToken(tokens, idx, options);
            };
            md.renderer.rules.fence = function (tokens, idx, options, env, self) {
                const token = tokens[idx];
                if (token.info === 'mermaid') {
                    return `<div class="mermaid">${token.content}</div>`;
                }
                return defaultFence(tokens, idx, options, env, self);
            };
        }

        // 初始化 markdown-it 并使用自定义 Mermaid 插件
        const md = window.markdownit();
        md.use(markdownItMermaid);

        // 发起流式请求并渲染内容
        async function fetchAndRenderContent(question) {

            const response = await fetch('/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Request-ID': crypto.randomUUID()

                },
                body: JSON.stringify({
                    question: question
                })
            });

            if (!response.body) {
                console.error('浏览器不支持 ReadableStream。');
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let { value: chunk, done: readerDone } = await reader.read();
            let content = '';

            while (!readerDone) {
                var chunkText = decoder.decode(chunk);

                chunkText = formatAndConcatJsonElements(chunkText)
                content += chunkText;

                // 渲染当前内容
                renderContent(content);

                ({ value: chunk, done: readerDone } = await reader.read());

            }
            addIcon()
        }
        var contentsElement = document.getElementById('contents');
        function renderContent(markdownContent) {
            // 渲染 Markdown 为 HTML
            const htmlContent = md.render(markdownContent);
            // 更新页面内容
            var newContentElement = getDiv()
            // 创建一个content并添加到contents中
            newContentElement.innerHTML = htmlContent;
            //document.getElementById('content').innerHTML = htmlContent;
            // 渲染 Mermaid 图表
            mermaid.init(undefined, document.querySelectorAll('.mermaid'));
        }
        var index = 0
        function getDiv() {
            if (document.getElementById("content" + index)) {
                return document.getElementById("content" + index)
            } else {
                const row = document.createElement('div');
                row.classList.add('row');
                //.col-6
                const col1 = document.createElement('div');
                col1.classList.add('col-1');
                col1.style = "text-align:right;";
                const img = document.createElement('img');
                img.src = "/logo.png"
                img.width = 20;
                col1.appendChild(img);
                row.appendChild(col1);
                //添加id为content1
                const col2 = document.createElement('div');
                col2.classList.add('col-11');
                col2.id = "content" + index;
                row.appendChild(col2);
                // Append the new content element to the contents element
                contentsElement.appendChild(row);
                return col2
            }
        }
        function formatAndConcatJsonElements(content) {
            // 将内容数组合并为一个字符串
            let contentStr = content;

            // 去掉开头的逗号
            if (contentStr.startsWith(",")) {
                contentStr = contentStr.substring(1);
            }

            // 去掉结尾的逗号
            if (contentStr.endsWith(",")) {
                contentStr = contentStr.slice(0, -1);
            }

            if (!contentStr.startsWith("[")) {
                contentStr = "[" + contentStr;
            }

            // 检查并添加后置 ]
            if (!contentStr.endsWith("]")) {
                contentStr += "]";
            }

            // 转换为 JSON 对象
            let jsonData;
            try {
                jsonData = JSON.parse(contentStr);
            } catch (error) {
                console.error("JSON 解析失败:", error);
                return null;
            }

            // 将 JSON 数组中的每个元素拼接成一个字符串
            const concatenatedString = jsonData.join("");

            return concatenatedString;
        }
        document.getElementById("send").addEventListener("click", function () {
            index++
            const question = document.getElementById("question").value;
            const row = document.createElement('div');
            row.classList.add('row');

            //const col1 = document.createElement('div');
            //col1.classList.add('col-1');
            //col1.style = "text-align:right;";
            //const img = document.createElement('img');
            //img.src = "/user.png"
            //img.width = 20;
            //col1.appendChild(img);
            //row.appendChild(col1);

            const col11 = document.createElement('div');
            col11.classList.add('col-11');
            col11.style = "background-color:#f0f0f0;padding:15px";
            const span = document.createElement('span');
            span.innerHTML = question;
            col11.appendChild(span);
            row.appendChild(col11);
            contentsElement.appendChild(row);
            fetchAndRenderContent(question);
            document.getElementById("question").value = "";
        });
        renderContent("欢迎使用NETSTAR产品，请输入你的支付场景，或调用产品的相关信息，我会为你提供接入服务！欢迎提问！")
        function addIcon() {
            document.querySelectorAll("code").forEach((codeElement) => {
                if (codeElement.parentNode.tagName === "PRE") {
                    // 确保 <pre> 容器有 copy-container 类以便定位
                    codeElement.parentNode.classList.add("copy-container");

                    // 创建复制按钮
                    const copyIcon = document.createElement("span");
                    copyIcon.classList.add("copy-icon");
                    copyIcon.textContent = "复制";

                    // 绑定点击事件
                    copyIcon.addEventListener("click", () => {
                        const codeContent = codeElement.textContent;

                        // 创建一个临时的文本框来复制内容
                        const tempTextArea = document.createElement("textarea");
                        tempTextArea.value = codeContent;
                        document.body.appendChild(tempTextArea);
                        tempTextArea.select();
                        document.execCommand("copy");
                        document.body.removeChild(tempTextArea);

                        // 可选：提示复制成功
                        alert("复制成功！");
                    });

                    // 把复制按钮插入到 <pre> 容器中
                    codeElement.parentNode.appendChild(copyIcon);
                }
            });
        }

    </script>
</body>
</html>
