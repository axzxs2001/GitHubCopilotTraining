<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>智能API助手</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="js/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsnview/build/index.css" />
    <script src="https://cdn.jsdelivr.net/npm/jsnview/build/index.min.js"></script>

</head>
<body>
    <div class="container-fluid" style="padding:0 80px;">
        <div class="row" style="margin-top:15px;">
            <div class="col row">
                <div class="col-auto">
                    <img src="logo.png" width="50" />
                </div>
                <div class="col">
                    <h1>智能API助手</h1>
                </div>
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col-sm-9">
                <div class="row" style="margin-top:5px;">
                    <div class="col row">
                        <div class="col-auto">
                            <label for="scenario" class="col-form-label">支付场景</label>
                        </div>
                        <div class="col">
                            <select class="form-select" id="scenario">
                                <option>无场景</option>
                                <option selected>Pos机扫码支付</option>
                                <option value="1">网站支付</option>
                            </select>
                        </div>
                    </div>
                    <div class="col row">
                        <div class="col-auto">
                            <label for="product" class="col-form-label">支付产品</label>
                        </div>
                        <div class="col">
                            <select class="form-select" id="product" onchange="loadProductAPIs()">
                                <option value="">无产品</option>
                                <option value="1" selected>CPM</option>
                                <option value="2">MPM</option>
                                <option>信用卡</option>
                            </select>
                        </div>
                    </div>
                    <div class="col row">
                        <div class="col-auto">
                            <label for="api" class="col-form-label">对应API</label>
                        </div>
                        <div class="col">
                            <select class="form-select" id="api">
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-top:5px;">
                    <div class="col row">
                        <div class="col-auto">
                            <label for="language" class="col-form-label">编程语言</label>
                        </div>
                        <div class="col">
                            <select class="form-select" id="language" onchange="languageChange()">
                            </select>
                        </div>
                    </div>
                    <div class="col row">
                    </div>
                    <div class="col row">
                        <div class="col" style="text-align:right;">
                            <img id="askLoading" src="loading.gif" style="width:40px;display:none" />
                            <button type="button" id="askBut" class="btn btn-primary" style="width:120px" onclick="ask()">生成代码</button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12 position-relative" style="padding-top: 10px;">
                        <div id="container" style="width:100%;height:700px; border: 1px solid grey;"></div>
                    </div>
                </div>

            </div>
            <div class="col-sm-3" style=" border-left: 1px solid lightgray; ">
                <div class="row">
                    <div class="col-12" style="text-align: right;margin-top:20px">
                        <img id="runLoading" src="loading.gif" style="width:40px;display:none" />
                        <button type="button" id="runBut" class="btn btn-success" style="width:120px" onclick="runCode()">运行</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col" style="text-align: left;margin-top:20px;">
                        <b>运行结果：</b>
                        <div id="runResult"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script src="../monaco-editor/min/vs/loader.js"></script>
    <script>
        var codeSettings=[]
        var codeSetting={}
        function loadCodeSetting(){
             axios.get("/smartapi/codesettings", {
                           headers: {
                                 'Content-Type': 'application/json'
                             }
                       })
                       .then(response => {
                           if (response.data != null) {
                               codeSettings=response.data
                               if(codeSettings.length>0){
                                   codeSetting=codeSettings[0];
                               }
                               response.data.forEach(element => {
                                   var option = document.createElement("option");
                                   option.text = element.languageName;
                                   option.value = element.id;
                                   document.getElementById("language").add(option);
                               });
                           } else {
                               console.log("/products is error")
                           }
                       })
                       .catch(error => {
                           console.error('请求失败:', error);
                       });

           this.loadProductAPIs(1);
        }
        function loadProductAPIs(productID){
             document.getElementById("api").innerHTML="";
            if(productID==null||productID==""){
                productID=document.getElementById("product").value;
            }
            axios.get("/smartapi/miniapidatas/"+productID, {
                           headers: {
                                 'Content-Type': 'application/json'
                             }
                       })
                       .then(response => {
                           if (response.data != null) {
                               console.log(response.data.data)
                               response.data.data.forEach(element => {
                                   var option = document.createElement("option");
                                   option.text = element.name;
                                   option.value = element.id;
                                   document.getElementById("api").add(option);
                               });
                           } else {
                               console.log("/miniapidatas is error")
                           }
                       })
                       .catch(error => {
                           console.error('请求失败:', error);
                       });
        }
        function languageChange(){
            var codeSettingID=document.getElementById("language").value;
            codeSetting=codeSettings.find(x=>x.id==codeSettingID);
        }
        loadCodeSetting();
        async function runCode(){
              const runResultDiv = document.getElementById("runResult");
              try {
                 document.getElementById("runLoading").style.display="inline";
                 document.getElementById("runBut").disabled= true;
                 runResultDiv.innerHTML="";
                 const headers = {
                      "Content-Type": "application/json"
                 };
                 const body = {
                      runTime:codeSetting.languageRuntime,
                      sourceCode: editor.getValue(),
                      codeSettingID:codeSetting.id,
                 };                                            
                  const url = "/smartapi/run?culture=ja-JP"; // 替换为你的流式 API 地址

                 // 使用 Fetch 发起请求
                 const response = await fetch(url,{
                     method: "POST",
                     headers: headers,
                     body: JSON.stringify(body), // 将请求体转换为 JSON 字符串
                 });

                 // 检查是否成功
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }

                 // 获取响应的可读流
                 const reader = response.body.getReader();
                 const decoder = new TextDecoder("utf-8");

                 let done = false;

                 while (!done) {
                     // 读取流中的数据
                     const { value, done: streamDone } = await reader.read();
                     done = streamDone;

                     if (value) {
                         const chunk = decoder.decode(value, { stream: true });
                         console.log(chunk);

                         var arr= JSON.parse("["+chunk.replace(/^[\[,]+|[\],]+$/g, "")+"]");
                         arr.forEach(element => {
                             if(element.dataType=="string"){
                                const li = document.createElement("li");
                                //如果成功字色为绿色，否则为红色
                                li.style.fontSize = "13px";
                                li.style.color = element.result?"black":"red";
                                li.textContent =(element.result?"成功：":"失败：")+ element.message;
                                runResultDiv.appendChild(li);
                             }else{
                                const div = document.createElement("div");
                               // div.style.fontSize = "13px";
                                runResultDiv.appendChild(div);
                                const options = {
                                    showLen: false,
                                    showType: false,
                                    showBrackets: true,
                                    showFoldmarker: false,
                                    colors: { boolean: '#ff2929', null: '#ff2929', string: '#690', number: '#905', float: '#002f99'
                                    }
                                }
                                const treeView = jsnview(JSON.parse(element.message), options);
                                div.appendChild(treeView)
                                const listItems = document.querySelectorAll('.jsv li');
                                listItems.forEach(item => {
                                    item.style.fontSize = '13px';
                                });
                                const psanItems = document.querySelectorAll('.jsv span');
                                psanItems.forEach(item => {
                                    item.style.fontSize = '13px';
                                });
                             }
                         });
                     }
                 }
                document.getElementById("runLoading").style.display="none";
                document.getElementById("runBut").disabled= false;
             } catch (error) {
                 document.getElementById("runLoading").style.display="none";
                 document.getElementById("runBut").disabled= false;
                 console.error("Error fetching stream:", error);
                 const li = document.createElement("li");
                 li.style.fontSize = "13px";
                 li.style.color = "red";
                 li.textContent ="失败："+ error;
                 runResultDiv.appendChild(li);
             }
        }

        require.config({ paths: { vs: "../monaco-editor/min/vs" } });
        var editor =null;
        require(["vs/editor/editor.main"], function () {
            editor = monaco.editor.create(
                 document.getElementById("container"),
                 {
                     value: [].join("\n"),
                     language:"csharp",
                     minimap:{
                         autohide:true,
                         maxColumn:0
                      },
                  });
        });
        function ask(){
           document.getElementById("askLoading").style.display="inline";
           document.getElementById("askBut").disabled= true;
           var language=codeSetting.language;

           const model = editor.getModel(); // 获取当前编辑器的模型
           monaco.editor.setModelLanguage(model, language); // 切换语言
           var api= document.getElementById("api").value;
           var apiQuery={
              codeSettingID:codeSetting.id,
              language:language,
              runtime:codeSetting.languageRuntime,
              apiid:api,
           }
           console.log(apiQuery)
           fetchAndRenderContent(apiQuery)
        }
        // 发起流式请求并渲染内容
        async function fetchAndRenderContent(apiQuery) {
            const response = await fetch('/smartapi/apiquery?culture=ja-JP', {
                       method: 'POST',
                       headers: {
                           'Content-Type': 'application/json',
                           'Request-ID': ""//crypto.randomUUID()
                       },
                       body:JSON.stringify(apiQuery)
              });
              if (!response.body) {
                   console.error('浏览器不支持 ReadableStream。');
                   return;
              }
              const reader = response.body.getReader();
              const decoder = new TextDecoder('utf-8');
              let { value: chunk, done: readerDone } = await reader.read();
              let content = '';
              while (!readerDone) {
                  var chunkText = decoder.decode(chunk);
                  chunkText = formatAndConcatJsonElements(chunkText)
                  content += chunkText;
                  // 渲染当前内容
                  renderContent(content);
                 ({ value: chunk, done: readerDone } = await reader.read());
              }
              document.getElementById("askLoading").style.display="none";
              document.getElementById("askBut").disabled= false;
          }
         var contentsElement = document.getElementById('contents');
         function renderContent(content) {
            editor.setValue(content);
         }

         function formatAndConcatJsonElements(content) {
               // 将内容数组合并为一个字符串
               let contentStr = content;

               // 去掉开头的逗号
               if (contentStr.startsWith(",")) {
                   contentStr = contentStr.substring(1);
               }

               // 去掉结尾的逗号
               if (contentStr.endsWith(",")) {
                   contentStr = contentStr.slice(0, -1);
               }

               if (!contentStr.startsWith("[")) {
                   contentStr = "[" + contentStr;
               }

               // 检查并添加后置 ]
               if (!contentStr.endsWith("]")) {
                   contentStr += "]";
               }

               // 转换为 JSON 对象
               let jsonData;
               try {
                   jsonData = JSON.parse(contentStr);
               } catch (error) {
                   console.error("JSON 解析失败:", error);
                   return null;
               }
                   // 将 JSON 数组中的每个元素拼接成一个字符串
               const concatenatedString = jsonData.join("");
               return concatenatedString;
         }

    </script>
</body>
</html>
